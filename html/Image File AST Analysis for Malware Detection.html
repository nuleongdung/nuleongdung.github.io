<!DOCTYPE html>
<html>

<head>
    <title>이미지 파일 검증 (AST 분석)</title>
</head>

<body>

    <h1>이미지 파일 검증 (AST 분석)</h1>

    <input type="file" id="imageFile" accept="image/*">
    <button onclick="analyzeImage()">이미지 분석</button>

    <h2>결과:</h2>
    <pre id="resultOutput"></pre>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.8.1/acorn.js"></script>
    <script>
        async function analyzeImage() {
            const imageFile = document.getElementById("imageFile").files[0];

            if (!imageFile) {
                document.getElementById("resultOutput").textContent = "이미지 파일을 선택해주세요.";
                return;
            }

            document.getElementById("resultOutput").textContent = "분석 중...";

            try {
                // 이미지 파일을 텍스트로 읽기 (Data URL)
                const reader = new FileReader();
                reader.onload = async function (event) {
                    const imageDataURL = event.target.result;

                    // Data URL에서 JavaScript 코드 추출 시도
                    const javascriptCode = extractJavaScriptFromImage(imageDataURL);

                    if (javascriptCode) {
                        // JavaScript 코드가 발견되면 AST 분석 수행
                        try {
                            const ast = acorn.parse(javascriptCode, { ecmaVersion: 2020 });

                            // AST 분석 (악성 코드 패턴 확인)
                            const isMalicious = await checkMaliciousCode(ast);

                            if (isMalicious) {
                                document.getElementById("resultOutput").textContent = "!!! 악성 코드 발견 !!!";
                            } else {
                                document.getElementById("resultOutput").textContent = "JavaScript 코드 발견, 악성 코드 패턴 없음.";
                            }
                        } catch (error) {
                            document.getElementById("resultOutput").textContent = "JavaScript 코드 파싱 오류: " + error;
                        }
                    } else {
                        document.getElementById("resultOutput").textContent = "JavaScript 코드 발견되지 않음.";
                    }
                };
                reader.onerror = function (error) {
                    document.getElementById("resultOutput").textContent = "파일 읽기 오류: " + error;
                };
                reader.readAsDataURL(imageFile);  // Data URL로 읽기
            } catch (error) {
                document.getElementById("resultOutput").textContent = "오류 발생: " + error;
            }
        }

        // Data URL에서 JavaScript 코드 추출 시도 (정규식 사용)
        function extractJavaScriptFromImage(imageDataURL) {
            // 매우 단순한 예제. 실제 환경에서는 더 정교한 패턴 사용 필요
            const javascriptPattern = /<script\s*>([\s\S]*?)<\/script>/i;  // <script> 태그 추출
            const match = imageDataURL.match(javascriptPattern);

            if (match && match[1]) {
                return match[1]; // <script> 태그 안의 코드 반환
            }

            // PNG 청크에서 문자열 추출 시도 (매우 기본적인 예제)
            const pngChunkPattern = /IDAT([\s\S]*?)IEND/i; //IDAT와 IEND 청크 사이의 데이터 추출 시도
            const pngMatch = imageDataURL.match(pngChunkPattern);
            if (pngMatch && pngMatch[1]) {
                try {
                    //Base64 디코딩을 시도하고, 결과가 JavaScript인지 확인 (더 정교한 검사 필요)
                    const decodedString = atob(pngMatch[1]);
                    //간단한 검사: "function", "var"와 같은 키워드 포함 여부
                    if (decodedString.includes("function") || decodedString.includes("var")) {
                        return decodedString;
                    }
                } catch (e) {
                    //디코딩 실패 시 무시
                }
            }
            return null;
        }


        // AST 분석 (악성 코드 패턴 확인) - 비동기 함수로 변경
        async function checkMaliciousCode(ast) {
            let isMalicious = false;

            function traverse(node) {
                if (node.type === "CallExpression") {
                    // eval() 함수 사용 확인
                    if (node.callee.name === "eval") {
                        isMalicious = true;
                        console.log("eval() 함수 발견!"); // 디버깅 용도
                        return;
                    }

                    // document.write() 함수 사용 확인
                    if (node.callee.type === "MemberExpression" &&
                        node.callee.object.name === "document" &&
                        node.callee.property.name === "write") {
                        isMalicious = true;
                        console.log("document.write() 함수 발견!"); // 디버깅 용도
                        return;
                    }

                    // XMLHttpRequest 사용 확인 (비동기 통신)
                    if (node.callee.type === "MemberExpression" &&
                        node.callee.object.name === "XMLHttpRequest") {
                        isMalicious = true;
                        console.log("XMLHttpRequest 사용 발견!"); // 디버깅 용도
                        return;
                    }
                }

                // AST 노드 순회
                for (const key in node) {
                    if (node.hasOwnProperty(key) && typeof node[key] === "object" && node[key] !== null) {
                        traverse(node[key]);
                    }
                }
            }

            traverse(ast);
            return isMalicious;
        }
    </script>

</body>

</html>